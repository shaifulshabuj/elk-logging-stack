# Sample Application Usage Guide

This document provides instructions on how to use the sample application that integrates with the ELK (Elasticsearch, Logstash, Kibana) logging stack. The sample application demonstrates how to generate and send logs to the ELK stack for centralized logging and visualization.

## Table of Contents

1. [Overview](#overview)
2. [Prerequisites](#prerequisites)
3. [Starting the Sample Application](#starting-the-sample-application)
4. [Available Endpoints](#available-endpoints)
5. [Log Types and Formats](#log-types-and-formats)
6. [Viewing Logs in Kibana](#viewing-logs-in-kibana)
7. [Troubleshooting](#troubleshooting)
8. [Customizing the Sample Application](#customizing-the-sample-application)

## Overview

The sample application is a Node.js Express server that generates various types of logs and sends them to the ELK stack via Logstash. It demonstrates best practices for application logging and integration with a centralized logging system.

Key features:
- Generates different log types (info, warn, error)
- Logs HTTP request details
- Captures exceptions and errors
- Can generate random sample logs for testing
- Uses Winston for structured logging
- Sends logs directly to Logstash via TCP

## Prerequisites

- Docker and Docker Compose installed
- ELK stack running (Elasticsearch, Logstash, Kibana)
- Port 8080 available on your host machine

## Starting the Sample Application

There are two ways to start the sample application:

### 1. Using the provided script

Run the following command from the `elk-logging-stack` directory:

```bash
./restart_sample_app.sh
```

This script will:
- Stop any existing sample-app container
- Verify that the ELK stack components are running
- Build and start the sample application
- Display available endpoints

### 2. Using Docker Compose directly

```bash
# From the elk-logging-stack directory
docker compose up -d sample-app
```

## Available Endpoints

Once the application is running, the following endpoints are available:

| Endpoint | Description | Example |
|----------|-------------|---------|
| `/` | Home page | `http://localhost:8080/` |
| `/info` | Generates info level logs | `http://localhost:8080/info` |
| `/warn` | Generates warning level logs | `http://localhost:8080/warn` |
| `/error` | Generates error level logs | `http://localhost:8080/error` |
| `/exception` | Generates exception logs | `http://localhost:8080/exception` |
| `/generate` | Generates random logs | `http://localhost:8080/generate?count=50` |

### Query Parameters

- The `/generate` endpoint accepts a `count` parameter to specify the number of random logs to generate (default: 10)
  - Example: `http://localhost:8080/generate?count=100` (generates 100 random logs)

## Log Types and Formats

The sample application generates logs in the following format:

```json
{
  "@timestamp": "2025-04-15T12:00:00.000Z",
  "level": "info",
  "message": "User 123 performed login",
  "service": "sample-app",
  "userId": 123,
  "action": "login",
  "result": "success",
  "processingTime": 45
}
```

### HTTP Request Logs

All HTTP requests to the application are automatically logged with the following information:

- HTTP method (GET, POST, etc.)
- URL path
- Status code
- Response time
- User agent
- IP address

Example:
```json
{
  "@timestamp": "2025-04-15T12:00:00.000Z",
  "level": "info",
  "type": "request",
  "method": "GET",
  "url": "/info",
  "status": 200,
  "duration": 5,
  "userAgent": "Mozilla/5.0...",
  "ip": "::1"
}
```

### Exception Logs

Exceptions include error details and stack traces:

```json
{
  "@timestamp": "2025-04-15T12:00:00.000Z",
  "level": "error",
  "message": "Exception occurred",
  "service": "sample-app",
  "error": "This is a sample exception",
  "stack": "Error: This is a sample exception\n    at ..."
}
```

## Viewing Logs in Kibana

To view the logs generated by the sample application:

1. Open Kibana at http://localhost:5601
2. Navigate to "Dashboards" in the left sidebar
3. Select "Sample Application Dashboard"

This dashboard includes:
- Request Count visualization
- Error Count visualization
- Response Time graph
- Detailed log table

### Custom Searches

You can create custom searches in Kibana using queries like:

- `service:sample-app AND level:error` - Show only error logs
- `service:sample-app AND userId:123` - Show logs for a specific user
- `service:sample-app AND duration>100` - Show slow requests

## Troubleshooting

### Common Issues

1. **Cannot access the sample application**
   - Verify the container is running: `docker ps | grep sample-app`
   - Check if port 8080 is already in use: `lsof -i :8080`
   - Look at the container logs: `docker logs sample-app`

2. **Logs not appearing in Kibana**
   - Verify Logstash is running: `docker ps | grep logstash`
   - Check Logstash logs: `docker logs logstash`
   - Verify Elasticsearch indices: `curl http://localhost:9200/_cat/indices`
   - Make sure the correct index pattern is selected in Kibana

3. **Application crashes**
   - Check the application logs: `docker logs sample-app`
   - Verify environment variables are set correctly in docker-compose.yml

## Customizing the Sample Application

You can customize the sample application by modifying the following files:

- `sample-app/app.js` - Main application code
- `sample-app/package.json` - Dependencies
- `sample-app/Dockerfile` - Container configuration

To add new log types or endpoints, modify the `app.js` file. After making changes, rebuild and restart the application using:

```bash
docker compose up -d --build sample-app
```

### Configuring Log Levels

By default, the application logs all levels (debug, info, warn, error). You can change the minimum log level by modifying the `level` property in the winston logger configuration in `app.js`.

### Sending Logs to a Different Destination

To send logs to a different Logstash instance, change the following environment variables in `docker-compose.yml`:

```yaml
environment:
  - LOGSTASH_HOST=your-logstash-host
  - LOGSTASH_PORT=your-logstash-port
```

Then restart the application using the restart script or docker compose.